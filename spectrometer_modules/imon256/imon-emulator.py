#MIT License
#
#Copyright (c) 2018 Luis Victor Muller Fabris
#
#Permission is hereby granted, free of charge, to any person obtaining a copy
#of this software and associated documentation files (the "Software"), to deal
#in the Software without restriction, including without limitation the rights
#to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
#copies of the Software, and to permit persons to whom the Software is
#furnished to do so, subject to the following conditions:
#
#The above copyright notice and this permission notice shall be included in all
#copies or substantial portions of the Software.
#
#THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
#IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
#FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
#AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
#LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
#OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
#SOFTWARE.
#
#
#
#
#
#This is the Imon 256 v6.0 device emulator.
#The purpose of this file is to emulate the Imon 256 for testing without the device.
#This file is used for testing only and should respond to firmware commands used by SpectraRead
#and also emulate known bugs/limitations in Imon firmware that could affect SpectraRead (with error messages for debugging printed to the terminal).
#-------------------------------------
#-------------------------------------
#-------------------------------------
from serial_emulator import SerialEmulator
import time
emulator = SerialEmulator('./ttydevice','./imon256')
readcmd=""
freq=0
nspec=0
a=0
inttime=0
while(True):
	readcmd=emulator.read()
	if(readcmd!=""):
		print("Got command: "+readcmd)
	if(readcmd=="*MEAS:TEMPE\r"):
		print("Measuring temperature")
		emulator.write(("Temperature: 22 C\r").encode('utf-8'))
	if(readcmd.find("*PARA:FFTPARA ")!=-1):
		freq=readcmd.split(" ")[1]
		inttime=readcmd.split(" ")[2]
		nspec=readcmd.split(" ")[3].split("\r")[0]
		emulator.write(("\06").encode('utf-8'))
		print("CONFIGURING "+str(nspec)+" spectrums with a frequency of "+str(freq)+" hz and a integration time of "+str(inttime)+" us")
	if(readcmd=="*MEAS:FSTMEAS\r"):
		print("MEASURING "+str(nspec)+" spectrums with a frequency of "+str(freq)+" hz and a integration time of "+str(inttime)+" us")
		i=0
		while(i<int(nspec)):
			if(a<2):
				emulator.write(("\x00\xA3\x0A\xED\x0A\xAA\x0B\x8A\x0B\x7B\x0B\x05\x0B\xFE\x0A\x99\x0B\xF1\x0B\xAB\x0B\x9C\x0B\xB9\x0B\xAA\x0B\x7E\x0B\x79\x0B\xB0\x0B\xB0\x0B\x8B\x0B\x99\x0B\x98\x0B\x9C\x0B\xB6\x0B\x99\x0B\xF6\x0B\x0E\x0C\xE2\x0B\xBD\x0B\x94\x0B\x9F\x0B\xB5\x0B\xAF\x0B\xA6\x0B\x66\x0B\x53\x0B\x5E\x0B\x31\x0B\x03\x0B\x2D\x0B\x4D\x0B\x49\x0B\x42\x0B\x13\x0B\x08\x0B\xD0\x0A\x86\x0A\xD5\x0A\x03\x0B\xD0\x0A\xAC\x0A\x55\x0A\x82\x0A\xB3\x0A\xCC\x0A\x9E\x0A\xB4\x0A\xCB\x0A\xAB\x0A\x80\x0A\x63\x0A\x70\x0A\xA3\x0A\xBD\x0A\xC0\x0A\x99\x0A\xAE\x0A\xAD\x0A\xCA\x0A\xC6\x0A\xCC\x0A\x81\x0A\x86\x0A\x89\x0A\x79\x0A\x54\x0A\x26\x0A\x37\x0A\x88\x0A\x74\x0A\x5E\x0A\x27\x0A\x13\x0A\x08\x0A\xF0\x09\xCD\x09\xAF\x09\x79\x09\x44\x09\x16\x09\x50\x09\x3F\x09\x22\x09\x18\x09\x07\x09\xE2\x08\x83\x08\x3D\x08\x5C\x08\x85\x08\x4F\x08\xFD\x07\x06\x08\xE8\x07\xE8\x07\xE1\x07\xB8\x07\x79\x07\x68\x07\x62\x07\x72\x07\x46\x07\x3A\x07\x3C\x07\x53\x07\x57\x07\x3F\x07\x0B\x07\x10\x07\x0D\x07\x3D\x07\x09\x07\xF1\x06\xAE\x06\xCC\x06\xE4\x06\xEA\x06\xD0\x06\xCF\x06\xCE\x06\x9A\x06\xA9\x06\x94\x06\x81\x06\x2F\x06\x19\x06\xFA\x05\xF6\x05\xF4\x05\xD3\x05\xDC\x05\xB5\x05\x69\x05\x42\x05\x43\x05\x20\x05\x02\x05\x06\x05\xF7\x04\xE7\x04\xC8\x04\xAB\x04\x89\x04\x71\x04\x71\x04\x58\x04\x41\x04\x3E\x04\x30\x04\x36\x04\x2A\x04\x0A\x04\x25\x04\x56\x05\xA1\x07\xD5\x06\xB1\x04\x0A\x04\xD7\x03\xE6\x03\x00\x04\xCE\x03\xC9\x03\xDB\x03\xD5\x03\xB6\x03\xB9\x03\xAA\x03\xCB\x03\xD0\x03\xD7\x03\x20\x04\xDF\x04\xA5\x04\xE4\x03\x8B\x03\x80\x03\x6F\x03\x6C\x03\x90\x03\x61\x03\x4C\x03\x59\x03\x4A\x03\x2C\x03\x14\x03\x04\x03\x08\x03\xF9\x02\xF4\x02\xDA\x02\xF2\x02\xE2\x02\xC8\x02\xC8\x02\xC1\x02\xBF\x02\xB3\x02\xAA\x02\xB4\x02\xB4\x02\xAB\x02\xC9\x02\x2F\x03\x1E\x04\x84\x03\xBF\x02\xA6\x02\x99\x02\xA3\x02\xB6\x02\xDB\x02\xD5\x02\xB4\x02\xBD\x02\xC9\x02\xA9\x02\xB8\x02\xBC\x02\xC8\x02\xDC\x02\xD0\x02\xC8\x02\xDA\x02\xDA\x02\xE0\x02\xDA\x02\xC6\x02\xC3\x02\xBB\x02\xC6\x02\xC7\x02\xA7\x02\xA1\x02\xA5\x02\xB1\x02\x8D\x02\xA3\x02\xBE\x02\xAA\x02\x7E\x02\x9A\x02\x83\x02\x8F\x02\x57\x02\x79\x02\x81\x02\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"))
			if(a>=2):
				emulator.write(("\x00\xCD\x08\x00\x09\x96\x09\x7E\x09\x82\x09\x12\x09\x12\x09\x87\x09\xCF\x09\x97\x09\x89\x09\xA5\x09\x8B\x09\x6F\x09\x69\x09\x9E\x09\x94\x09\x7D\x09\x93\x09\x80\x09\x85\x09\xAE\x09\x7E\x09\xCB\x09\xE4\x09\xBC\x09\x99\x09\x7F\x09\x77\x09\x9A\x09\x9A\x09\x7E\x09\x59\x09\x45\x09\x5F\x09\x29\x09\x07\x09\x2A\x09\x44\x09\x47\x09\x46\x09\x0F\x09\x0B\x09\xDA\x08\xA1\x08\xE5\x08\x09\x09\xD9\x08\xBD\x08\x84\x08\x98\x08\xD8\x08\xDA\x08\xB6\x08\xCC\x08\xD8\x08\xCE\x08\xA3\x08\x8D\x08\xA2\x08\xCA\x08\xD7\x08\xDB\x08\xC0\x08\xCF\x08\xCB\x08\xE9\x08\xDD\x08\xE4\x08\xAB\x08\xA7\x08\xAA\x08\xAE\x08\x86\x08\x61\x08\x75\x08\xB7\x08\x99\x08\x97\x08\x5C\x08\x52\x08\x3F\x08\x2E\x08\x19\x08\x02\x08\xD9\x07\xA7\x07\x87\x07\xB2\x07\xA9\x07\x8C\x07\x89\x07\x79\x07\x55\x07\x12\x07\xDE\x06\xF4\x06\x14\x07\xDE\x06\xA7\x06\xAD\x06\x98\x06\x98\x06\x97\x06\x75\x06\x40\x06\x2A\x06\x28\x06\x3D\x06\x1A\x06\x10\x06\x0D\x06\x2C\x06\x28\x06\x1F\x06\xEA\x05\xEC\x05\xF4\x05\x0E\x06\xE9\x05\xDF\x05\xA8\x05\xB6\x05\xD5\x05\xD4\x05\xB1\x05\xBE\x05\xBB\x05\x82\x05\x92\x05\x86\x05\x7B\x05\x3B\x05\x27\x05\x15\x05\x0B\x05\x0D\x05\xF9\x04\x03\x05\xD4\x04\x9F\x04\x86\x04\x7C\x04\x5D\x04\x50\x04\x59\x04\x3F\x04\x38\x04\x20\x04\xFC\x03\xEC\x03\xDF\x03\xE2\x03\xBA\x03\xAE\x03\xAE\x03\xA1\x03\xAF\x03\xA5\x03\x97\x03\x9B\x03\x8E\x04\x61\x06\xC2\x05\x0B\x04\x89\x03\x65\x03\x6E\x03\x85\x03\x53\x03\x56\x03\x60\x03\x6B\x03\x40\x03\x49\x03\x31\x03\x62\x03\x5B\x03\x5C\x03\xAA\x03\x30\x04\x0D\x04\x6B\x03\x20\x03\x19\x03\x16\x03\x0E\x03\x2B\x03\x04\x03\xEA\x02\xFF\x02\xF5\x02\xD3\x02\xC6\x02\xBB\x02\xC5\x02\xAA\x02\xAD\x02\xA1\x02\xA9\x02\xA2\x02\x87\x02\x90\x02\x7E\x02\x8A\x02\x7B\x02\x7B\x02\x82\x02\x79\x02\x71\x02\x91\x02\xD7\x02\x9F\x03\x1E\x03\x7A\x02\x6E\x02\x6D\x02\x71\x02\x6F\x02\x91\x02\x9B\x02\x8C\x02\x84\x02\x91\x02\x6E\x02\x7B\x02\x7A\x02\x84\x02\x96\x02\x8F\x02\x8D\x02\x9D\x02\x9C\x02\x95\x02\xA1\x02\x88\x02\x7E\x02\x82\x02\x80\x02\x88\x02\x6E\x02\x73\x02\x71\x02\x74\x02\x56\x02\x5D\x02\x79\x02\x78\x02\x58\x02\x65\x02\x4A\x02\x66\x02\x42\x02\x48\x02\x50\x02\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"))
				a=0
			a=a+1
			i=i+1
			time.sleep(0.000016)
		print("Acquisition is over")
	time.sleep(0.001)
